<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Registro de Compras</title>
    
    <!-- Bootstrap CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Material Icons (for icons) -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa; /* Bootstrap's default light background */
            height: 100vh; /* Full viewport height */
            /* Removed overflow: hidden from here, will manage dynamically */
        }
        
        /* New class for controlling body overflow */
        body.no-scroll {
            overflow: hidden;
        }

        .header-bg {
            background-color: #3f51b5; /* Deep indigo for header */
        }

        .card-title-bg {
            background-color: #3f51b5; /* Deep indigo for card titles */
        }

        .error-text {
            color: #dc3545; /* Bootstrap's danger red */
            font-size: 0.875em; /* Smaller font size */
            margin-top: 0.25rem;
            display: block;
        }
        
        .form-control.is-invalid {
            border-color: #dc3545 !important;
        }

        .autocomplete-container {
            position: relative;
            width: 100%;
        }
        
        .autocomplete-list {
            position: absolute;
            z-index: 1050; /* Above Bootstrap modals */
            top: 100%;
            left: 0;
            right: 0;
            max-height: 12.5rem; /* 200px */
            overflow-y: auto;
            background-color: white;
            border: 1px solid #dee2e6; /* Bootstrap border color */
            border-top: none;
            border-bottom-left-radius: 0.25rem;
            border-bottom-right-radius: 0.25rem;
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15); /* Bootstrap shadow */
            display: none;
        }
        
        .autocomplete-list div {
            padding: 0.625rem; /* 10px */
            cursor: pointer;
        }
        
        .autocomplete-list div:hover {
            background-color: #e9ecef; /* Bootstrap light gray */
        }
        
        .autocomplete-active {
            background-color: #cfe2ff !important; /* Bootstrap primary-100 */
        }

        .text-editor {
            width: 100%;
            min-height: 6.25rem; /* 100px */
            border: 1px solid #dee2e6;
            padding: 0.5rem; /* 8px */
            margin-top: 0.5rem; /* 8px */
            border-radius: 0.25rem;
            font-family: inherit;
        }
        
        .copy-success {
            background-color: #28a745 !important; /* Bootstrap success green */
            color: white !important;
        }

        /* Custom toast container */
        .toast-container {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 2000;
        }

        /* Tab specific styles (retained for tab-pane content, but nav links will be vertical) */
        .nav-tabs .nav-link {
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
            border: none;
            border-bottom: 2px solid transparent;
            transition: color 0.3s ease, border-bottom 0.3s ease;
        }

        .nav-tabs .nav-link.active {
            color: white;
            background-color: transparent;
            border-color: white;
        }

        .nav-tabs .nav-link:hover {
            border-color: rgba(255, 255, 255, 0.5);
        }

        .stats-item {
            padding: 0.75rem;
            border-bottom: 1px solid #eee;
            background-color: #f8f9fa;
            border-radius: 0.25rem;
        }
        .stats-item:last-child {
            border-bottom: none;
        }
        .stats-item strong {
            display: block;
            margin-bottom: 0.25rem;
            color: #3f51b5; /* Deep indigo for strong text */
        }

        /* Material Icons sizing for Bootstrap buttons */
        .btn .material-icons {
            font-size: 1.25rem; /* Adjust icon size */
            vertical-align: middle;
        }

        /* Accordion custom styles */
        .accordion-button:not(.collapsed) {
            color: #3f51b5; /* Indigo for active accordion header */
            background-color: #e6e9f5;
            box-shadow: inset 0 -1px 0 rgba(0,0,0,.125);
        }
        .accordion-button:focus {
            box-shadow: none;
            border-color: transparent;
        }
        .accordion-item {
            border: 1px solid rgba(0,0,0,.125);
            margin-bottom: 0.5rem;
            border-radius: 0.25rem;
        }
        .accordion-body {
            padding: 1rem;
        }

        /* New styles for sidebar */
        .sidebar {
            width: 250px;
            background-color: #3f51b5;
            color: white;
            padding: 1rem;
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
            transition: transform 0.3s ease-in-out;
            position: fixed; /* Make it fixed for overlay behavior on small screens */
            top: 0;
            bottom: 0;
            left: -250px; /* Initially hidden off-screen */
            z-index: 1060; /* Ensure it's above main content */
        }

        /* When body has sidebar-expanded, show the sidebar */
        body.sidebar-expanded .sidebar {
            transform: translateX(250px); /* Slide it into view */
        }

        /* Overlay for when sidebar is open on small screens */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1059; /* Below sidebar, above content */
            display: none; /* Hidden by default */
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
        }

        body.sidebar-expanded .overlay {
            display: block;
            opacity: 1;
        }

        /* Sidebar toggle button */
        #sidebarToggle {
            display: none; /* Hidden by default, will be shown via media query */
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1070; /* Above sidebar and overlay */
        }

        /* Adjust for small screens (max-width: 767.98px) */
        @media (max-width: 767.98px) {
            body {
                /* Removed overflow: hidden from here */
            }
            .main-content {
                margin-left: 0; /* No margin on small screens */
            }
            #sidebarToggle {
                display: block !important; /* Show toggle button on small screens */
            }
        }

        /* For screens larger than or equal to medium (md) breakpoint */
        @media (min-width: 768px) {
            body {
                display: flex; /* Re-enable flex for side-by-side layout */
                overflow: auto; /* Allow scrolling on body if content overflows */
            }
            .sidebar {
                position: relative; /* Back to relative positioning */
                left: 0; /* Always visible */
                transform: translateX(0); /* Ensure no transform */
                flex-shrink: 0; /* Prevent shrinking */
            }
            .main-content {
                flex-grow: 1; /* Allow main content to take up remaining space */
                margin-left: 0; /* Remove fixed margin-left */
            }
            #sidebarToggle {
                display: none !important; /* Hide toggle button on large screens */
            }
            .overlay {
                display: none !important; /* Hide overlay on large screens */
            }
        }

        /* Floating buttons */
        .floating-buttons-container {
            position: fixed;
            bottom: 1.5rem; /* 24px */
            right: 1.5rem; /* 24px */
            display: flex;
            flex-direction: row; /* Changed to row */
            gap: 0.75rem; /* 12px */
            z-index: 1000; /* Ensure they are above other content */
            align-items: flex-end; /* Align to the bottom when in a row */
            flex-wrap: wrap; /* Allow wrapping if many buttons */
            justify-content: flex-end; /* Align buttons to the right */
        }

        .floating-buttons-container .btn {
            border-radius: 50px; /* Make them round initially */
            width: 56px; /* Standard FAB size */
            height: 56px; /* Standard FAB size */
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); /* Add shadow */
            transition: all 0.2s ease, width 0.3s ease; /* Add width to transition */
            padding: 0; /* Remove default padding for initial round state */
            overflow: hidden; /* Hide overflowing text initially */
        }

        .floating-buttons-container .btn:hover {
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
            transform: translateY(-2px);
            width: auto; /* Expand width on hover */
            padding: 0 1rem; /* Add padding for text */
            border-radius: 0.375rem; /* Make it more like a pill on hover */
        }

        .floating-buttons-container .btn .material-icons {
            font-size: 1.5rem; /* Larger icon for FAB */
            margin-right: 0; /* Remove margin initially */
        }

        .floating-buttons-container .btn:hover .material-icons {
            margin-right: 0.5rem; /* Add margin when text appears */
        }

        /* Show text on hover for FABs */
        .floating-buttons-container .btn span {
            display: none; /* Hide text by default */
            white-space: nowrap; /* Prevent text from wrapping */
            transition: opacity 0.3s ease;
            opacity: 0;
        }

        .floating-buttons-container .btn:hover span {
            display: inline-block; /* Show text on hover */
            opacity: 1;
        }

        /* Adjust for small screens to stack vertically if needed */
        @media (max-width: 767.98px) {
            .floating-buttons-container {
                flex-direction: column; /* Stack vertically on small screens */
                align-items: flex-end; /* Align to the right */
                bottom: 1rem;
                right: 1rem;
            }
            .floating-buttons-container .btn {
                width: 56px; /* Keep round on small screens unless hovered */
                padding: 0;
            }
            .floating-buttons-container .btn:hover {
                width: auto; /* Still expand on hover */
                padding: 0 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Left Sidebar Navigation -->
    <nav class="sidebar d-flex flex-column align-items-start py-4" id="sidebar">
        <h1 class="h5 mb-4 text-white text-center w-100">Menú</h1>
        <ul class="nav nav-pills flex-column w-100">
            <li class="nav-item">
                <a class="nav-link active" id="registro-tab-sidebar" data-bs-toggle="tab" data-bs-target="#tab-registro-compras" type="button" role="tab" aria-controls="tab-registro-compras" aria-selected="true">
                    <i class="material-icons me-2">receipt_long</i> Registro de Compras
                </a>
            </li>
            <!-- Removed Dashboard tab -->
            <li class="nav-item">
                <a class="nav-link" id="reportes-tab-sidebar" data-bs-toggle="tab" data-bs-target="#tab-reportes" type="button" role="tab" aria-controls="tab-reportes" aria-selected="false">
                    <i class="material-icons me-2">assessment</i> Reportes
                </a>
            </li>
        </ul>
    </nav>

    <!-- Main Content Area -->
    <main class="main-content">
        <!-- Toggle button for small screens -->
        <button id="sidebarToggle" class="btn btn-primary position-fixed top-0 start-0 m-3 rounded-circle shadow" style="z-index: 1060;">
            <i class="material-icons">menu</i>
        </button>
        <div class="container-fluid"> <!-- Use container-fluid for full width -->
            <h1 class="h4 mb-4 text-dark">Sistema de Registro de Compras</h1> <!-- Main title -->
            <div class="tab-content" id="myTabContent">
                <!-- Contenido de la pestaña de Registro de Compras -->
                <div class="tab-pane fade show active" id="tab-registro-compras" role="tabpanel" aria-labelledby="registro-tab-sidebar">
                    <div class="row g-4">
                        <!-- Sección de formulario (izquierda) -->
                        <div class="col-md-6"> <!-- Changed to col-md-6 for 1x2 layout -->
                            <div class="card shadow-sm mb-4">
                                <div class="card-header card-title-bg text-white p-3 rounded-top">
                                    <h2 class="h5 mb-0">Registrar Compra</h2>
                                </div>
                                <div class="card-body p-4">
                                    <div class="mb-3">
                                        <label for="codigo" class="form-label">Código</label>
                                        <input type="text" id="codigo" class="form-control rounded-lg shadow-sm">
                                        <div id="codigo-error" class="error-text"></div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="monto" class="form-label">Monto</label>
                                        <input type="number" id="monto" class="form-control rounded-lg shadow-sm">
                                        <div id="monto-error" class="error-text"></div>
                                    </div>

                                    <div class="autocomplete-container mb-3">
                                        <label for="cliente" class="form-label">Cliente (Opcional)</label>
                                        <input type="text" id="cliente" class="form-control rounded-lg shadow-sm">
                                        <div id="cliente-error" class="error-text"></div>
                                        <div id="autocomplete-list" class="autocomplete-list"></div>
                                    </div>
                                    
                                    <div class="d-flex flex-column gap-3 mt-4">
                                        <div class="d-flex flex-wrap gap-2">
                                            <button id="agregar" class="btn btn-primary d-flex align-items-center justify-content-center shadow-sm rounded-lg">
                                                <i class="material-icons me-2">add</i> Agregar Compra
                                            </button>
                                        </div>

                                        <!-- Removed Generar Reporte button from here -->
                                        <!-- <div class="d-flex flex-wrap gap-2">
                                            <button id="generarReporteBtn" class="btn btn-success d-flex align-items-center justify-content-center shadow-sm rounded-lg">
                                                <i class="material-icons me-2">description</i> Generar Reporte
                                            </button>
                                        </div> -->

                                        <!-- Removed Guardar Datos, Cargar Datos, Exportar Datos, Importar Datos buttons -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sección de tabla de compras (derecha) -->
                        <div class="col-md-6"> <!-- Changed to col-md-6 for 1x2 layout -->
                            <div class="card shadow-sm mb-4">
                                <div class="card-header card-title-bg text-white p-3 rounded-top">
                                    <h2 class="h5 mb-0">Compras Registradas</h2>
                                </div>
                                <div class="card-body p-4 overflow-auto">
                                    <table id="tabla-compras" class="table table-striped table-hover">
                                        <thead>
                                            <tr>
                                                <th scope="col">Código</th>
                                                <th scope="col">Cliente</th>
                                                <th scope="col">Monto</th>
                                                <th scope="col">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Table rows will be inserted here by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sección de resultados (Agrupados) - Ahora ocupa todo el ancho abajo -->
                    <div class="row g-4">
                        <div class="col-12">
                            <div class="card shadow-sm mb-4">
                                <div class="card-header card-title-bg text-white p-3 rounded-top">
                                    <h2 class="h5 mb-0">Resultados Agrupados</h2>
                                </div>
                                <div class="card-body p-4">
                                    <div id="clientes-agrupados" class="accordion" id="accordionClientes">
                                        <p class="text-center text-muted">No hay datos para mostrar</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Removed Dashboard tab content -->

                <!-- Contenido de la pestaña de Reportes -->
                <div class="tab-pane fade" id="tab-reportes" role="tabpanel" aria-labelledby="reportes-tab-sidebar">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header card-title-bg text-white p-3 rounded-top">
                            <h2 class="h5 mb-0">Reporte de Compras</h2>
                        </div>
                        <div class="card-body p-4">
                            <h3 class="h6 mb-3">Filtros</h3>
                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label for="reporteClienteFilter" class="form-label">Cliente</label>
                                    <select id="reporteClienteFilter" class="form-select rounded-lg shadow-sm">
                                        <option value="">Seleccionar cliente</option>
                                        <!-- Opciones de clientes se cargarán dinámicamente -->
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="reportePeriodoFilter" class="form-label">Periodo</label>
                                    <select id="reportePeriodoFilter" class="form-select rounded-lg shadow-sm">
                                        <option value="">Seleccionar periodo</option>
                                        <option value="today">Hoy</option>
                                        <option value="last7days">Últimos 7 días</option>
                                        <option value="last30days">Últimos 30 días</option>
                                        <option value="thisMonth">Este mes</option>
                                        <option value="lastMonth">Mes anterior</option>
                                        <option value="thisYear">Este año</option>
                                        <option value="all">Todo el historial</option>
                                    </select>
                                </div>
                            </div>
                            <div class="d-flex justify-content-end mb-4">
                                <button id="generarReporteTabBtn" class="btn btn-primary d-flex align-items-center justify-content-center shadow-sm rounded-lg">
                                    Generar Reporte
                                </button>
                            </div>

                            <h3 class="h6 mb-3">Resumen de Compras</h3>
                            <div class="row g-3 mb-4">
                                <div class="col-md-4">
                                    <div class="card text-center p-3 shadow-sm rounded-lg">
                                        <div class="card-body">
                                            <h5 class="card-title text-muted">Total de Compras</h5>
                                            <p class="card-text h4 fw-bold text-primary" id="reporteTotalCompras">0</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card text-center p-3 shadow-sm rounded-lg">
                                        <div class="card-body">
                                            <h5 class="card-title text-muted">Total Gastado</h5>
                                            <p class="card-text h4 fw-bold text-success" id="reporteTotalGastado">$ 0</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card text-center p-3 shadow-sm rounded-lg">
                                        <div class="card-body">
                                            <h5 class="card-title text-muted">Promedio por Compra</h5>
                                            <p class="card-text h4 fw-bold text-info" id="reportePromedioCompra">$ 0</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <h3 class="h6 mb-3">Detalle de Compras</h3>
                            <div class="table-responsive">
                                <table id="reporteTablaDetalle" class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th scope="col">Fecha</th>
                                            <th scope="col">Cliente</th>
                                            <th scope="col">Código</th>
                                            <th scope="col">Monto</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Detalles del reporte se insertarán aquí -->
                                        <tr>
                                            <td colspan="4" class="text-center text-muted py-3">No hay datos para mostrar</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div class="d-flex justify-content-end gap-2 mt-4">
                                <button id="exportarReporteBtn" class="btn btn-secondary d-flex align-items-center justify-content-center shadow-sm rounded-lg">
                                    <i class="material-icons me-2">download</i> Exportar
                                </button>
                                <button id="imprimirReporteBtn" class="btn btn-secondary d-flex align-items-center justify-content-center shadow-sm rounded-lg">
                                    <i class="material-icons me-2">print</i> Imprimir
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Overlay for closing sidebar on small screens -->
    <div class="overlay" id="sidebar-overlay"></div>

    <!-- Floating Buttons Container -->
    <div class="floating-buttons-container">
        <button id="saveSalesBtn" class="btn btn-primary shadow-sm">
            <i class="material-icons">save</i>
            <span>Guardar Ventas</span>
        </button>
        <button id="loadSalesBtn" class="btn btn-secondary shadow-sm">
            <i class="material-icons">folder_open</i>
            <span>Cargar Ventas</span>
        </button>
        <button id="generarReporteBtn" class="btn btn-success shadow-sm">
            <i class="material-icons">description</i>
            <span>Generar Reporte</span>
        </button>
        <button id="agrupar" class="btn btn-info shadow-sm">
            <i class="material-icons">group_work</i>
            <span>Agrupar</span>
        </button>
        <button id="limpiar" class="btn btn-danger shadow-sm">
            <i class="material-icons">delete_sweep</i>
            <span>Limpiar</span>
        </button>
    </div>

    <!-- Toast Container for notifications -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">Notificación</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toast-message">
                <!-- Message will be injected here -->
            </div>
        </div>
    </div>
    
    <!-- Modales de Bootstrap -->

    <!-- Modal de confirmación para limpiar todo -->
    <div class="modal fade" id="confirmClearAllDialog" tabindex="-1" aria-labelledby="confirmClearAllDialogLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmClearAllDialogLabel">Confirmar acción</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    ¿Está seguro que desea eliminar **todos** los datos de compras actuales? Esta acción no se puede deshacer.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="confirmClearAllBtn">Aceptar</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmación para eliminar una sola compra -->
    <div class="modal fade" id="confirmDeletePurchaseDialog" tabindex="-1" aria-labelledby="confirmDeletePurchaseDialogLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmDeletePurchaseDialogLabel">Confirmar Eliminación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    ¿Está seguro que desea eliminar esta compra?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="confirmDeletePurchaseBtn">Eliminar</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para mostrar el reporte -->
    <div class="modal fade" id="reportDialog" tabindex="-1" aria-labelledby="reportDialogLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reportDialogLabel">Reporte de Compras</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <pre id="report-content" class="dialog-content"></pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success d-flex align-items-center" id="copyReportBtn">
                        <i class="material-icons me-2">content_copy</i> Copiar Reporte
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Guardar Ventas -->
    <div class="modal fade" id="saveSalesModal" tabindex="-1" aria-labelledby="saveSalesModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="saveSalesModalLabel">Guardar Ventas del Día</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="saveDateInput" class="form-label">Fecha de Venta</label>
                        <input type="date" id="saveDateInput" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label for="saveCategorySelect" class="form-label">Categoría de Venta</label>
                        <select id="saveCategorySelect" class="form-select">
                            <option value="VentasDiarias">Ventas Diarias</option>
                            <option value="LiveFacebook">Live Facebook</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="confirmSaveBtn">Guardar</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Cargar Ventas -->
    <div class="modal fade" id="loadSalesModal" tabindex="-1" aria-labelledby="loadSalesModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loadSalesModalLabel">Cargar Ventas Guardadas</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="loadSalesSelect" class="form-label">Seleccionar Venta Guardada</label>
                        <select id="loadSalesSelect" class="form-select">
                            <option value="">-- Seleccionar --</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="confirmLoadBtn">Cargar</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        // Array to store current purchases
        let compras = [];
        // Variable to store the index of the purchase being edited
        let editandoIndex = -1; 
        // Variable to store the index of the purchase to be deleted
        let deleteConfirmIndex = -1;
        
        // Local Storage Key for sales metadata
        const SAVES_METADATA_KEY = 'sales_metadata';

        // DOM elements
        const codigoInput = document.getElementById('codigo');
        const clienteInput = document.getElementById('cliente');
        const montoInput = document.getElementById('monto');
        const agregarBtn = document.getElementById('agregar');
        const agruparBtn = document.getElementById('agrupar'); // Floating button
        const limpiarBtn = document.getElementById('limpiar'); // Floating button
        const generarReporteBtn = document.getElementById('generarReporteBtn'); // Floating button
        const tablaCompras = document.getElementById('tabla-compras').getElementsByTagName('tbody')[0];
        const clientesAgrupados = document.getElementById('clientes-agrupados');
        const autocompleteList = document.getElementById('autocomplete-list');
        
        // Modal instances
        const confirmClearAllModal = new bootstrap.Modal(document.getElementById('confirmClearAllDialog'));
        const confirmDeletePurchaseModal = new bootstrap.Modal(document.getElementById('confirmDeletePurchaseDialog'));
        const reportModal = new bootstrap.Modal(document.getElementById('reportDialog'));
        const saveSalesModal = new bootstrap.Modal(document.getElementById('saveSalesModal'));
        const loadSalesModal = new bootstrap.Modal(document.getElementById('loadSalesModal'));

        // Dialog elements (buttons inside modals)
        const confirmClearAllBtn = document.getElementById('confirmClearAllBtn');
        const confirmDeletePurchaseBtn = document.getElementById('confirmDeletePurchaseBtn');
        const copyReportBtn = document.getElementById('copyReportBtn');

        // Tab elements (now controlled by sidebar)
        const registroTabSidebar = document.getElementById('registro-tab-sidebar');
        const reportesTabSidebar = document.getElementById('reportes-tab-sidebar');

        // New elements for sidebar toggle
        const sidebarToggleBtn = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('sidebar'); // Get the sidebar element
        const sidebarOverlay = document.getElementById('sidebar-overlay'); // Get the overlay element

        // Reportes tab elements
        const reporteClienteFilter = document.getElementById('reporteClienteFilter');
        const reportePeriodoFilter = document.getElementById('reportePeriodoFilter');
        const generarReporteTabBtnReportes = document.getElementById('generarReporteTabBtn'); // Renamed to avoid conflict with floating button
        const reporteTotalCompras = document.getElementById('reporteTotalCompras');
        const reporteTotalGastado = document.getElementById('reporteTotalGastado');
        const reportePromedioCompra = document.getElementById('reportePromedioCompra');
        const reporteTablaDetalle = document.getElementById('reporteTablaDetalle').getElementsByTagName('tbody')[0];
        const exportarReporteBtn = document.getElementById('exportarReporteBtn');
        const imprimirReporteBtn = document.getElementById('imprimirReporteBtn');

        // Save/Load Sales Elements
        const saveSalesBtn = document.getElementById('saveSalesBtn');
        const loadSalesBtn = document.getElementById('loadSalesBtn');
        const saveDateInput = document.getElementById('saveDateInput');
        const saveCategorySelect = document.getElementById('saveCategorySelect');
        const confirmSaveBtn = document.getElementById('confirmSaveBtn');
        const loadSalesSelect = document.getElementById('loadSalesSelect');
        const confirmLoadBtn = document.getElementById('confirmLoadBtn');
        
        // Function to format amounts in Chilean currency format
        function formatoMonedaChilena(monto) {
            return '$ ' + monto.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }
        
        // Function to display notification (Bootstrap Toast)
        function mostrarNotificacion(mensaje, type = 'info') {
            const toastElement = document.getElementById('liveToast');
            const toastBody = document.getElementById('toast-message');
            toastBody.textContent = mensaje;

            // Optional: Add classes for different types of notifications (e.g., success, danger)
            toastElement.classList.remove('text-bg-success', 'text-bg-danger', 'text-bg-info');
            if (type === 'success') {
                toastElement.classList.add('text-bg-success');
            } else if (type === 'danger') {
                toastElement.classList.add('text-bg-danger');
            } else {
                toastElement.classList.add('text-bg-info');
            }

            // Create new Toast instance with a delay of 3000ms (3 seconds)
            const toast = new bootstrap.Toast(toastElement, {
                delay: 3000 // Set delay to 3 seconds
            });
            toast.show();
        }
        
        // Function to validate the form
        function validarFormulario() {
            let esValido = true;
            
            // Validate code
            if (!codigoInput.value.trim()) {
                codigoInput.classList.add('is-invalid');
                document.getElementById('codigo-error').textContent = 'El código es obligatorio';
                esValido = false;
            } else {
                codigoInput.classList.remove('is-invalid');
                document.getElementById('codigo-error').textContent = '';
            }
            
            // Validate amount
            if (!montoInput.value || isNaN(montoInput.value) || parseFloat(montoInput.value) <= 0) {
                montoInput.classList.add('is-invalid');
                document.getElementById('monto-error').textContent = 'Ingrese un monto válido mayor a cero';
                esValido = false;
            } else {
                montoInput.classList.remove('is-invalid');
                document.getElementById('monto-error').textContent = '';
            }

            // Client is optional, no "required" validation needed
            clienteInput.classList.remove('is-invalid');
            document.getElementById('cliente-error').textContent = '';
            
            return esValido;
        }

        // Event listeners for real-time validation
        codigoInput.addEventListener('input', validarFormulario);
        montoInput.addEventListener('input', validarFormulario);

        // Function to delete a purchase
        function eliminarCompra(index) {
            compras.splice(index, 1);
            actualizarTablaCompras();
            mostrarNotificacion('Compra eliminada');
        }

        // Function to load purchase data into the form for editing
        function editarCompra(index) {
            const compra = compras[index];
            codigoInput.value = compra.codigo;
            clienteInput.value = compra.cliente;
            montoInput.value = compra.monto;

            // Remove invalid states
            codigoInput.classList.remove('is-invalid');
            clienteInput.classList.remove('is-invalid');
            montoInput.classList.remove('is-invalid');

            // Change the "Add Purchase" button text to "Update Purchase"
            agregarBtn.innerHTML = '<i class="material-icons me-2">update</i> Actualizar Compra';
            agregarBtn.classList.remove('btn-primary'); // Remove original color
            agregarBtn.classList.add('btn-info'); // Add accent color to indicate editing
            editandoIndex = index; // Save the index of the element being edited

            mostrarNotificacion(`Editando compra con código: ${compra.codigo}`);
        }
        
        // Function to add a purchase
        function agregarCompra() {
            if (!validarFormulario()) return;
            
            const nuevaCompra = {
                codigo: codigoInput.value.trim(),
                cliente: clienteInput.value.trim(), // Client is now optional
                monto: Math.round(parseFloat(montoInput.value)), // Round to integer
                fecha: new Date().toISOString().slice(0, 10) // Add current date for reporting
            };
            
            compras.unshift(nuevaCompra); // Add to the beginning of the array to be the first
            actualizarTablaCompras();
            limpiarFormulario();
            mostrarNotificacion('Compra agregada correctamente', 'success');
        }

        // Function to update an existing purchase
        function actualizarCompra() {
            if (!validarFormulario()) return;

            const compraActualizada = {
                codigo: codigoInput.value.trim(),
                cliente: clienteInput.value.trim(), // Client is now optional
                monto: Math.round(parseFloat(montoInput.value)),
                fecha: compras[editandoIndex].fecha // Keep original date if editing
            };

            compras[editandoIndex] = compraActualizada; // Overwrite the existing purchase
            actualizarTablaCompras();
            limpiarFormulario();
            editandoIndex = -1; // Reset editing index
            agregarBtn.innerHTML = '<i class="material-icons me-2">add</i> Agregar Compra'; // Restore button text
            agregarBtn.classList.remove('btn-info'); // Remove accent color if added
            agregarBtn.classList.add('btn-primary'); // Restore original color
            mostrarNotificacion('Compra actualizada correctamente', 'success');
        }
        
        // Function to update the purchases table
        function actualizarTablaCompras() {
            tablaCompras.innerHTML = '';
            
            if (compras.length === 0) {
                const fila = tablaCompras.insertRow();
                const celda = fila.insertCell(0);
                celda.colSpan = 4;
                celda.textContent = 'No hay compras registradas';
                celda.className = 'text-center text-muted py-3';
                return;
            }
            
            compras.forEach((compra, index) => {
                const fila = tablaCompras.insertRow();
                
                const celdaCodigo = fila.insertCell(0);
                celdaCodigo.textContent = compra.codigo;
                
                const celdaCliente = fila.insertCell(1);
                celdaCliente.textContent = compra.cliente || 'N/A'; // Display N/A if client is optional and not entered
                
                const celdaMonto = fila.insertCell(2);
                celdaMonto.textContent = formatoMonedaChilena(compra.monto); // Chilean currency format
                
                const celdaAcciones = fila.insertCell(3);
                celdaAcciones.classList.add('d-flex', 'gap-1'); // Add flexbox and gap for horizontal buttons
                
                // Delete button
                const eliminarBtn = document.createElement('button');
                eliminarBtn.className = 'btn btn-sm btn-danger'; // Removed me-1 as gap handles spacing
                eliminarBtn.innerHTML = '<i class="material-icons">delete</i>';
                eliminarBtn.onclick = () => confirmarEliminarCompra(index); // Use confirmation function
                celdaAcciones.appendChild(eliminarBtn);

                // Edit button
                const editarBtn = document.createElement('button');
                editarBtn.className = 'btn btn-sm btn-primary';
                editarBtn.innerHTML = '<i class="material-icons">edit</i>';
                editarBtn.onclick = () => editarCompra(index);
                celdaAcciones.appendChild(editarBtn);
            });
        }
        
        // Function to confirm deleting a single purchase
        function confirmarEliminarCompra(index) {
            deleteConfirmIndex = index; // Save the index of the purchase to be deleted
            confirmDeletePurchaseModal.show();
        }

        // Event listener for the accept button in the individual deletion modal
        confirmDeletePurchaseBtn.addEventListener('click', () => {
            if (deleteConfirmIndex !== -1) {
                compras.splice(deleteConfirmIndex, 1);
                actualizarTablaCompras();
                mostrarNotificacion('Compra eliminada correctamente', 'success');
                deleteConfirmIndex = -1; // Reset the index
            }
            confirmDeletePurchaseModal.hide();
        });

        // Function to clear the form
        function limpiarFormulario() {
            codigoInput.value = '';
            clienteInput.value = '';
            montoInput.value = '';
            codigoInput.classList.remove('is-invalid');
            clienteInput.classList.remove('is-invalid');
            montoInput.classList.remove('is-invalid');
            document.getElementById('codigo-error').textContent = '';
            document.getElementById('cliente-error').textContent = '';
            document.getElementById('monto-error').textContent = '';
            
            // Clear autocomplete list
            autocompleteList.innerHTML = '';
            autocompleteList.style.display = 'none';

            // If editing, restore the button to "Add Purchase"
            if (editandoIndex !== -1) {
                agregarBtn.innerHTML = '<i class="material-icons me-2">add</i> Agregar Compra';
                agregarBtn.classList.remove('btn-info');
                agregarBtn.classList.add('btn-primary');
                editandoIndex = -1;
            }
        }
        
        // Function to get unique clients
        function obtenerClientesUnicos() {
            const clientesUnicos = new Set();
            compras.forEach(compra => {
                // Only add clients if they are not empty
                if (compra.cliente.trim() !== '') {
                    clientesUnicos.add(compra.cliente);
                }
            });
            return Array.from(clientesUnicos);
        }
        
        // Function to show autocomplete suggestions
        function mostrarSugerencias(input) {
            const valor = input.value.toLowerCase();
            autocompleteList.innerHTML = '';
            
            if (!valor) {
                autocompleteList.style.display = 'none';
                return;
            }
            
            const clientes = obtenerClientesUnicos();
            let hayCoincidencias = false;
            
            clientes.forEach(cliente => {
                if (cliente.toLowerCase().includes(valor)) {
                    const div = document.createElement('div');
                    div.className = 'p-2 cursor-pointer hover:bg-light';
                    // Highlight the matching part
                    const regex = new RegExp(valor, 'gi');
                    const clienteResaltado = cliente.replace(regex, match => `<strong class="fw-semibold">${match}</strong>`);
                    div.innerHTML = clienteResaltado;
                    div.addEventListener('click', function() {
                        clienteInput.value = cliente;
                        autocompleteList.style.display = 'none';
                        clienteInput.focus();
                    });
                    autocompleteList.appendChild(div);
                    hayCoincidencias = true;
                }
            });
            
            if (hayCoincidencias) {
                autocompleteList.style.display = 'block';
            } else {
                autocompleteList.style.display = 'none';
            }
        }
        
        // Function to group purchases by client
        function agruparPorCliente() {
            if (compras.length === 0) {
                mostrarNotificacion('No hay compras registradas para agrupar', 'danger');
                clientesAgrupados.innerHTML = '<p class="text-center text-muted">No hay datos para mostrar</p>';
                return;
            }
            
            // Group purchases by client
            const clientesMap = new Map();
            
            compras.forEach(compra => {
                // Use a default client name if the client field is optional and empty
                const nombreCliente = compra.cliente.trim() === '' ? 'Cliente sin nombre' : compra.cliente;

                if (!clientesMap.has(nombreCliente)) {
                    clientesMap.set(nombreCliente, {
                        compras: [],
                        total: 0,
                        editableMessage: '' // Store editable message here
                    });
                }
                
                const clienteData = clientesMap.get(nombreCliente);
                clienteData.compras.push(compra);
                clienteData.total += compra.monto;
                // Initialize editable message if it's the first time for this client
                if (!clienteData.editableMessage) {
                    clienteData.editableMessage = generarTextoCliente(nombreCliente, clienteData);
                }
            });
            
            // Display grouped results using accordion
            mostrarClientesAgrupados(clientesMap);
            mostrarNotificacion('Compras agrupadas por cliente', 'info');
        }
        
        // Function to generate the message text for the client (original, not editable)
        function generarTextoCliente(cliente, data) {
            let texto = `Estimado(a) ${cliente},\n\n`;
            texto += `Este es el detalle de sus compras,\n\n`;
            texto += `DETALLE DE COMPRAS\n`;
            
            data.compras.forEach(compra => {
                texto += `- Código: ${compra.codigo}, Monto: ${formatoMonedaChilena(compra.monto)}\n`;
            });
            
            texto += `\nTOTAL: ${formatoMonedaChilena(data.total)}\n\n`;
            texto += `Por favor transferir a la siguiente cuenta: \n`;
            texto += `Nombre: Alicia Yolhet Arias Cea\n`;
            texto += `Banco: Mercado Pago\n`;
            texto += `Tipo de Cuenta: Vista\n`;
            texto += `N° de cuenta: 1038060282\n`;
            texto += `Rut: 10376458-0`;
            
            return texto;
        }
        
        // Function to copy text to clipboard
        function copiarAlPortapapeles(texto, boton) {
            // Create a temporary textarea element
            const textarea = document.createElement('textarea');
            textarea.value = texto;
            textarea.setAttribute('readonly', '');
            textarea.style.position = 'absolute';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            
            // Select the text and copy it
            textarea.select();
            let exitoso = false;
            
            try {
                exitoso = document.execCommand('copy');
            } catch (err) {
                exitoso = false;
            }
            
            // Remove the temporary textarea
            document.body.removeChild(textarea);
            
            if (exitoso) {
                // Change button style to indicate success
                boton.classList.add('copy-success');
                boton.innerHTML = '<i class="material-icons me-2">check</i> Copiado';
                
                // Restore button after 2 seconds
                setTimeout(() => {
                    boton.classList.remove('copy-success');
                    boton.innerHTML = '<i class="material-icons me-2">content_copy</i> Copiar';
                }, 2000);
                
                mostrarNotificacion('Texto copiado al portapapeles', 'success');
            } else {
                mostrarNotificacion('Error al copiar el texto', 'danger');
            }
        }
        
        // Function to display grouped clients with Bootstrap Accordion
        function mostrarClientesAgrupados(clientesMap) {
            clientesAgrupados.innerHTML = '';
            
            if (clientesMap.size === 0) {
                clientesAgrupados.innerHTML = '<p class="text-center text-muted">No hay datos para mostrar</p>';
                return;
            }
            
            let accordionIdCounter = 0; // For unique accordion IDs

            clientesMap.forEach((data, cliente) => {
                const accordionItemId = `accordionItem${accordionIdCounter++}`;
                const collapseTargetId = `collapse${accordionItemId}`;

                const accordionItem = document.createElement('div');
                accordionItem.className = 'accordion-item';
                accordionItem.innerHTML = `
                    <h2 class="accordion-header" id="heading${accordionItemId}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseTargetId}" aria-expanded="false" aria-controls="${collapseTargetId}">
                            <span class="fw-semibold text-dark">${cliente}</span>
                            <span class="ms-auto fw-semibold text-secondary">Total: ${formatoMonedaChilena(data.total)}</span>
                        </button>
                    </h2>
                    <div id="${collapseTargetId}" class="accordion-collapse collapse" aria-labelledby="heading${accordionItemId}" data-bs-parent="#accordionClientes">
                        <div class="accordion-body">
                            <!-- Client details content -->
                            <div class="mb-3">
                                <div class="editable-message-display"></div> <!-- This will hold the dynamic text -->
                                
                                <div class="d-flex gap-2 mb-3">
                                    <button class="editar-btn btn btn-primary d-flex align-items-center">
                                        <i class="material-icons me-2">edit</i> Editar Texto
                                    </button>
                                    <button class="copiar-btn btn btn-success d-flex align-items-center">
                                        <i class="material-icons me-2">content_copy</i> Copiar
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Editing area (initially hidden) -->
                            <div class="editor-area d-none">
                                <textarea class="text-editor form-control"></textarea>
                                <div class="d-flex gap-2 mt-2">
                                    <button class="cerrar-editor-btn btn btn-primary d-flex align-items-center">
                                        <i class="material-icons me-2">close</i> Cerrar Editor
                                    </button>
                                    <button class="cancelar-btn btn btn-secondary d-flex align-items-center">
                                        <i class="material-icons me-2">cancel</i> Cancelar
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Account information is now included in the editable text, so this div is no longer needed here. -->
                            
                            <!-- Details table -->
                            <table class="table table-bordered table-sm mt-3 shadow-sm rounded overflow-hidden details-table">
                                <thead class="table-light">
                                    <tr>
                                        <th scope="col" class="px-3 py-2 text-start text-uppercase small text-muted">Código</th>
                                        <th scope="col" class="px-3 py-2 text-start text-uppercase small text-muted">Monto</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white">
                                    ${data.compras.map(compra => `
                                        <tr>
                                            <td class="px-3 py-2 text-nowrap">${compra.codigo}</td>
                                            <td class="px-3 py-2 text-nowrap">${formatoMonedaChilena(compra.monto)}</td>
                                        </tr>
                                    `).join('')}
                                    <tr class="fw-bold bg-light">
                                        <td class="px-3 py-2 text-nowrap">TOTAL</td>
                                        <td class="px-3 py-2 text-nowrap">${formatoMonedaChilena(data.total)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                clientesAgrupados.appendChild(accordionItem);
                
                // Get references to elements within the newly created accordion item
                const editorArea = accordionItem.querySelector('.editor-area');
                const textEditor = accordionItem.querySelector('.text-editor');
                const mensajeDiv = accordionItem.querySelector('.mb-3'); // Contains editable-message-display and buttons
                const editableMessageDisplay = accordionItem.querySelector('.editable-message-display');
                const tablaDetalles = accordionItem.querySelector('.details-table');

                const editarBtn = accordionItem.querySelector('.editar-btn');
                const copiarBtn = accordionItem.querySelector('.copiar-btn');
                const cerrarEditorBtn = accordionItem.querySelector('.cerrar-editor-btn');
                const cancelarBtn = accordionItem.querySelector('.cancelar-btn');

                // Generate initial text and set it to the display area
                const textoInicial = generarTextoCliente(cliente, data);
                editableMessageDisplay.textContent = textoInicial; // Display the initial generated text
                
                // Store the initial text for potential cancellation
                editableMessageDisplay.dataset.originalText = textoInicial; 

                editarBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // Set the editor's value to the currently displayed text (which might be edited)
                    textEditor.value = editableMessageDisplay.textContent; 
                    mensajeDiv.classList.add('d-none');
                    tablaDetalles.classList.add('d-none');
                    editorArea.classList.remove('d-none');
                });
                
                copiarBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // This copies the current content of the textarea, including user edits
                    copiarAlPortapapeles(textEditor.value, copiarBtn);
                });
                
                cerrarEditorBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // Update the displayed text with the content from the editor
                    editableMessageDisplay.textContent = textEditor.value; 
                    editorArea.classList.add('d-none');
                    mensajeDiv.classList.remove('d-none');
                    tablaDetalles.classList.remove('d-none');
                    mostrarNotificacion('Editor cerrado. El texto mostrado ha sido actualizado temporalmente.', 'info');
                });
                
                cancelarBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // Revert the editor's content and the displayed text to the original generated text
                    textEditor.value = editableMessageDisplay.dataset.originalText;
                    editableMessageDisplay.textContent = editableMessageDisplay.dataset.originalText;
                    editorArea.classList.add('d-none');
                    mensajeDiv.classList.remove('d-none');
                    tablaDetalles.classList.remove('d-none');
                    mostrarNotificacion('Edición cancelada. El texto ha vuelto a su versión original.', 'info');
                });
            });
        }
        
        // Function to confirm before clearing all
        function confirmarLimpiarTodo() {
            confirmClearAllModal.show();
        }
        
        // Function to clear all
        function limpiarTodo() {
            compras = [];
            actualizarTablaCompras();
            clientesAgrupados.innerHTML = '<p class="text-center text-muted">No hay datos para mostrar</p>';
            limpiarFormulario();
            mostrarNotificacion('Todos los datos han sido eliminados', 'success');
            confirmClearAllModal.hide();
        }

        // Function to export data to a JSON file (this is for the general report, not the removed local storage export)
        function exportarDatosReporte() {
            // This function is for the "Exportar" button in the Reports tab
            const selectedClient = reporteClienteFilter.value;
            const selectedPeriod = reportePeriodoFilter.value;
            const filteredCompras = filtrarCompras(selectedClient, selectedPeriod);

            if (filteredCompras.length === 0) {
                mostrarNotificacion('No hay datos en el reporte actual para exportar.', 'info');
                return;
            }

            const dataToExport = {
                filtros: {
                    cliente: selectedClient || 'Todos',
                    periodo: selectedPeriod || 'Todo el historial'
                },
                resumen: {
                    totalCompras: filteredCompras.length,
                    totalGastado: filteredCompras.reduce((sum, compra) => sum + compra.monto, 0),
                    promedioPorCompra: filteredCompras.length > 0 ? filteredCompras.reduce((sum, compra) => sum + compra.monto, 0) / filteredCompras.length : 0
                },
                detalle: filteredCompras
            };

            const dataStr = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reporte_compras_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            mostrarNotificacion('Reporte exportado correctamente.', 'success');
        }

        // Function to generate the report (in the Purchase Registration tab)
        function generarReporteRegistroTab() {
            if (compras.length === 0) {
                mostrarNotificacion('No hay compras registradas para generar un reporte', 'danger');
                return;
            }

            let reporteTexto = "--- REPORTE DE COMPRAS ---\n\n";

            const comprasConNombre = compras.filter(compra => compra.cliente.trim() !== '');
            const comprasSinNombre = compras.filter(compra => compra.cliente.trim() === '');

            // Section of purchases with name
            reporteTexto += "--- COMPRAS CON CLIENTE ESPECIFICADO ---\n";
            if (comprasConNombre.length > 0) {
                let totalConNombre = 0;
                comprasConNombre.forEach((compra, index) => {
                    reporteTexto += `${index + 1}. Código: ${compra.codigo}, Cliente: ${compra.cliente}, Monto: ${formatoMonedaChilena(compra.monto)}\n`;
                    totalConNombre += compra.monto;
                });
                reporteTexto += `\nTOTAL COMPRAS CON NOMBRE: ${formatoMonedaChilena(totalConNombre)}\n`;
                reporteTexto += `CANTIDAD DE COMPRAS CON NOMBRE: ${comprasConNombre.length}\n`;
            } else {
                reporteTexto += "No hay compras registradas con cliente especificado.\n";
            }

            reporteTexto += "\n--- COMPRAS SIN CLIENTE ESPECIFICADO ---\n";
            if (comprasSinNombre.length > 0) {
                let totalSinNombre = 0;
                comprasSinNombre.forEach((compra, index) => {
                    reporteTexto += `${index + 1}. Código: ${compra.codigo}, Monto: ${formatoMonedaChilena(compra.monto)}\n`;
                    totalSinNombre += compra.monto;
                });
                reporteTexto += `\nTOTAL COMPRAS SIN NOMBRE: ${formatoMonedaChilena(totalSinNombre)}\n`;
                reporteTexto += `CANTIDAD DE COMPRAS SIN NOMBRE: ${comprasSinNombre.length}\n`;
            } else {
                reporteTexto += "No hay compras registradas sin cliente especificado.\n";
            }

            reporteTexto += "\n--- RESUMEN GENERAL ---\n";
            const totalGeneral = compras.reduce((sum, compra) => sum + compra.monto, 0);
            reporteTexto += `TOTAL GENERAL DE COMPRAS: ${formatoMonedaChilena(totalGeneral)}\n`;
            reporteTexto += `CANTIDAD TOTAL DE COMPRAS: ${compras.length}\n`;
            reporteTexto += "\n---------------------------\n";

            document.getElementById('report-content').textContent = reporteTexto; // Display the report in the pre
            reportModal.show();
        }

        // --- Functions for the new Reports tab ---

        // Function to populate the client filter in the Reports tab
        function populateReporteClienteFilter() {
            const clientes = obtenerClientesUnicos();
            reporteClienteFilter.innerHTML = '<option value="">Seleccionar cliente</option>'; // Reset and add default option
            clientes.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente;
                option.textContent = cliente;
                reporteClienteFilter.appendChild(option);
            });
        }

        // Function to filter purchases by client and period
        function filtrarCompras(cliente, periodo) {
            let filteredCompras = [...compras]; // Start with all purchases

            // Filter by client
            if (cliente) {
                filteredCompras = filteredCompras.filter(compra => compra.cliente === cliente);
            }

            // Filter by period
            if (periodo && periodo !== 'all') {
                const now = new Date();
                filteredCompras = filteredCompras.filter(compra => {
                    const purchaseDate = new Date(compra.fecha); // Assuming 'fecha' is in YYYY-MM-DD format
                    switch (periodo) {
                        case 'today':
                            return purchaseDate.toDateString() === now.toDateString();
                        case 'last7days':
                            const sevenDaysAgo = new Date(now);
                            sevenDaysAgo.setDate(now.getDate() - 7);
                            return purchaseDate >= sevenDaysAgo && purchaseDate <= now;
                        case 'last30days':
                            const thirtyDaysAgo = new Date(now);
                            thirtyDaysAgo.setDate(now.getDate() - 30);
                            return purchaseDate >= thirtyDaysAgo && purchaseDate <= now;
                        case 'thisMonth':
                            return purchaseDate.getMonth() === now.getMonth() && purchaseDate.getFullYear() === now.getFullYear();
                        case 'lastMonth':
                            const lastMonth = new Date(now);
                            lastMonth.setMonth(now.getMonth() - 1);
                            return purchaseDate.getMonth() === lastMonth.getMonth() && purchaseDate.getFullYear() === lastMonth.getFullYear();
                        case 'thisYear':
                            return purchaseDate.getFullYear() === now.getFullYear();
                        default:
                            return true; // Should not happen with 'all' handled
                    }
                });
            }
            return filteredCompras;
        }

        // Function to generate and display the report in the Reports tab
        function generarReporteTab() {
            const selectedClient = reporteClienteFilter.value;
            const selectedPeriod = reportePeriodoFilter.value;

            const filteredCompras = filtrarCompras(selectedClient, selectedPeriod);

            // Update summary cards
            const totalItems = filteredCompras.length;
            const totalAmount = filteredCompras.reduce((sum, compra) => sum + compra.monto, 0);
            const averageAmount = totalItems > 0 ? totalAmount / totalItems : 0;

            reporteTotalCompras.textContent = totalItems;
            reporteTotalGastado.textContent = formatoMonedaChilena(totalAmount);
            reportePromedioCompra.textContent = formatoMonedaChilena(Math.round(averageAmount));

            // Update detail table
            reporteTablaDetalle.innerHTML = '';
            if (filteredCompras.length === 0) {
                const fila = reporteTablaDetalle.insertRow();
                const celda = fila.insertCell(0);
                celda.colSpan = 4;
                celda.textContent = 'No hay datos para mostrar con los filtros seleccionados';
                celda.className = 'text-center text-muted py-3';
            } else {
                filteredCompras.forEach(compra => {
                    const fila = reporteTablaDetalle.insertRow();
                    fila.insertCell(0).textContent = compra.fecha;
                    fila.insertCell(1).textContent = compra.cliente || 'N/A';
                    fila.insertCell(2).textContent = compra.codigo;
                    fila.insertCell(3).textContent = formatoMonedaChilena(compra.monto);
                });
            }
            mostrarNotificacion('Reporte generado correctamente', 'success');
        }

        // Function to print the current report (from the Reports tab)
        function imprimirReporte() {
            const printContent = document.getElementById('tab-reportes').cloneNode(true);
            
            // Remove buttons and other interactive elements from the cloned content for printing
            const buttons = printContent.querySelectorAll('button, input[type="file"], label.btn, .floating-buttons-container');
            buttons.forEach(btn => btn.remove());

            const filters = printContent.querySelectorAll('.row.g-3.mb-4');
            filters.forEach(filter => filter.style.display = 'none'); // Hide filters for print

            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Reporte de Compras</title>');
            // Include Bootstrap CSS for basic styling in print
            printWindow.document.write('<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">');
            printWindow.document.write('<style>');
            printWindow.document.write('body { font-family: \'Inter\', sans-serif; margin: 20px; }');
            printWindow.document.write('.card { border: 1px solid #dee2e6; margin-bottom: 1rem; }');
            printWindow.document.write('.card-header { background-color: #3f51b5; color: white; padding: 0.75rem 1.25rem; border-bottom: 1px solid rgba(0,0,0,.125); }');
            printWindow.document.write('.table { width: 100%; margin-bottom: 1rem; color: #212529; border-collapse: collapse; }');
            printWindow.document.write('.table th, .table td { padding: 0.75rem; vertical-align: top; border-top: 1px solid #dee2e6; }');
            printWindow.document.write('.table thead th { vertical-align: bottom; border-bottom: 2px solid #dee2e6; }');
            printWindow.document.write('.table-striped tbody tr:nth-of-type(odd) { background-color: rgba(0,0,0,.05); }');
            printWindow.document.write('.text-center { text-align: center; }');
            printWindow.document.write('.text-muted { color: #6c757d; }');
            printWindow.document.write('.h4, .h5, .h6 { margin-bottom: 0.5rem; font-weight: 500; line-height: 1.2; }');
            printWindow.document.write('.fw-bold { font-weight: 700 !important; }');
            printWindow.document.write('.text-primary { color: #0d6efd !important; }');
            printWindow.document.write('.text-success { color: #198754 !important; }');
            printWindow.document.write('.text-info { color: #0dcaf0 !important; }');
            printWindow.document.write('</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(printContent.innerHTML);
            printWindow.document.close();
            printWindow.print();
        }

        // --- Local Storage Functions ---

        // Function to get today's date in YYYY-MM-DD format
        function getTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Function to save sales data to local storage
        function saveSalesData(date, category) {
            const saveKey = `sales_${date}_${category}`;
            localStorage.setItem(saveKey, JSON.stringify(compras));

            let savesMetadata = JSON.parse(localStorage.getItem(SAVES_METADATA_KEY) || '[]');
            
            // Check if this specific save (date + category) already exists in metadata
            const existingIndex = savesMetadata.findIndex(
                (save) => save.date === date && save.category === category
            );

            if (existingIndex > -1) {
                // Update existing entry
                savesMetadata[existingIndex].timestamp = new Date().toISOString();
            } else {
                // Add new entry
                savesMetadata.push({
                    date: date,
                    category: category,
                    key: saveKey,
                    timestamp: new Date().toISOString()
                });
            }
            localStorage.setItem(SAVES_METADATA_KEY, JSON.stringify(savesMetadata));
            mostrarNotificacion(`Ventas de ${date} (${category}) guardadas correctamente.`, 'success');
            populateLoadSalesDropdown(); // Update load dropdown after saving
        }

        // Function to load sales data from local storage
        function loadSalesData(saveKey) {
            const savedData = localStorage.getItem(saveKey);
            if (savedData) {
                compras = JSON.parse(savedData);
                actualizarTablaCompras();
                agruparPorCliente(); // Re-group after loading
                generarReporteTab(); // Update reports tab
                mostrarNotificacion('Ventas cargadas correctamente.', 'success');
            } else {
                mostrarNotificacion('No se encontraron ventas para la selección.', 'danger');
            }
        }

        // Function to populate the load sales dropdown
        function populateLoadSalesDropdown() {
            loadSalesSelect.innerHTML = '<option value="">-- Seleccionar --</option>';
            const savesMetadata = JSON.parse(localStorage.getItem(SAVES_METADATA_KEY) || '[]');
            
            // Sort by date and then category for better organization
            savesMetadata.sort((a, b) => {
                const dateComparison = new Date(b.date) - new Date(a.date);
                if (dateComparison === 0) {
                    return a.category.localeCompare(b.category);
                }
                return dateComparison;
            });

            savesMetadata.forEach(save => {
                const option = document.createElement('option');
                option.value = save.key;
                option.textContent = `${save.date} - ${save.category === 'LiveFacebook' ? 'Live Facebook' : 'Ventas Diarias'}`;
                loadSalesSelect.appendChild(option);
            });
        }

        // Event listeners for buttons
        agregarBtn.addEventListener('click', () => {
            if (editandoIndex === -1) {
                agregarCompra();
            } else {
                actualizarCompra();
            }
        });

        agruparBtn.addEventListener('click', agruparPorCliente);
        limpiarBtn.addEventListener('click', confirmarLimpiarTodo);
        generarReporteBtn.addEventListener('click', generarReporteRegistroTab); // Event listener for the new floating button

        // Dialog event listeners
        confirmClearAllBtn.addEventListener('click', limpiarTodo);

        copyReportBtn.addEventListener('click', function() {
            copiarAlPortapapeles(document.getElementById('report-content').textContent, this);
        });
        
        // Event listener for autocomplete
        clienteInput.addEventListener('input', function() {
            mostrarSugerencias(this);
        });
        
        // Close autocomplete list if clicked outside
        document.addEventListener('click', function(e) {
            if (e.target !== clienteInput && e.target !== autocompleteList) {
                autocompleteList.style.display = 'none';
            }
        });
        
        // Keyboard navigation for autocomplete
        clienteInput.addEventListener('keydown', function(e) {
            const items = autocompleteList.getElementsByTagName('div');
            if (items.length === 0) return;
            
            // Find the current active element
            let activeIndex = -1;
            for (let i = 0; i < items.length; i++) {
                if (items[i].classList.contains('autocomplete-active')) {
                    activeIndex = i;
                    break;
                }
            }
            
            // Down arrow key
            if (e.keyCode === 40) {
                e.preventDefault();
                activeIndex++;
                if (activeIndex >= items.length) activeIndex = 0;
                setActiveItem(items, activeIndex);
            }
            // Up arrow key
            else if (e.keyCode === 38) {
                e.preventDefault();
                activeIndex--;
                if (activeIndex < 0) activeIndex = items.length - 1;
                setActiveItem(items, activeIndex);
            }
            // Enter key
            else if (e.keyCode === 13 && activeIndex > -1) {
                e.preventDefault();
                items[activeIndex].click();
            }
        });
        
        // Function to set the active item in the autocomplete list
        function setActiveItem(items, index) {
            // Remove active class from all elements
            for (let i = 0; i < items.length; i++) {
                items[i].classList.remove('autocomplete-active');
            }
            // Add active class to the selected element
            if (index > -1 && items.length > 0) {
                items[index].classList.add('autocomplete-active');
                // Ensure the element is visible in the list
                items[index].scrollIntoView({ block: 'nearest' });
            }
        }
        
        // Tab switching logic (using Bootstrap's built-in tab functionality)
        document.addEventListener('shown.bs.tab', function (event) {
            if (event.target.id === 'reportes-tab-sidebar') {
                populateReporteClienteFilter(); // Populate client filter when Reports tab is clicked
                generarReporteTab(); // Generate initial report
            }
            // Close sidebar if on small screen after tab is clicked
            if (window.innerWidth < 768) {
                document.body.classList.remove('sidebar-expanded');
                document.body.classList.remove('no-scroll'); // Ensure no-scroll is removed
            }
        });

        // Function to toggle sidebar visibility
        function toggleSidebar() {
            document.body.classList.toggle('sidebar-expanded');
            if (window.innerWidth < 768) { // Only apply no-scroll on small screens
                document.body.classList.toggle('no-scroll', document.body.classList.contains('sidebar-expanded'));
            }
        }

        // Event listener for sidebar toggle button
        if (sidebarToggleBtn) {
            sidebarToggleBtn.addEventListener('click', toggleSidebar);
        }

        // Close sidebar when clicking outside on small screens or on a sidebar link
        document.addEventListener('click', function(event) {
            if (window.innerWidth < 768 && document.body.classList.contains('sidebar-expanded')) {
                const isClickInsideSidebar = sidebar.contains(event.target);
                const isClickOnToggleButton = sidebarToggleBtn.contains(event.target);
                
                // If click is outside sidebar and not on the toggle button, close sidebar
                if (!isClickInsideSidebar && !isClickOnToggleButton) {
                    document.body.classList.remove('sidebar-expanded');
                    document.body.classList.remove('no-scroll'); // Remove no-scroll when sidebar closes
                } else if (isClickInsideSidebar && event.target.closest('.sidebar .nav-link')) {
                    // If click is inside sidebar and on a nav link, close sidebar after a small delay
                    setTimeout(() => {
                        document.body.classList.remove('sidebar-expanded');
                        document.body.classList.remove('no-scroll'); // Remove no-scroll when sidebar closes via nav link
                    }, 150); 
                }
            }
        });

        // Adjust sidebar state on resize
        window.addEventListener('resize', function() {
            // On large screens, ensure sidebar is always visible and toggle button is hidden
            if (window.innerWidth >= 768) {
                document.body.classList.remove('sidebar-expanded');
                document.body.classList.remove('no-scroll'); // Ensure no-scroll is off on large screens
            } else {
                // If resizing to small screen and sidebar is expanded, re-apply no-scroll
                if (document.body.classList.contains('sidebar-expanded')) {
                    document.body.classList.add('no-scroll');
                }
            }
        });

        // Event listeners for Reports tab filters and buttons
        reporteClienteFilter.addEventListener('change', generarReporteTab);
        reportePeriodoFilter.addEventListener('change', generarReporteTab);
        generarReporteTabBtnReportes.addEventListener('click', generarReporteTab); // Use the renamed variable here
        exportarReporteBtn.addEventListener('click', exportarDatosReporte);
        imprimirReporteBtn.addEventListener('click', imprimirReporte);

        // Event listeners for Save/Load Sales buttons
        saveSalesBtn.addEventListener('click', () => {
            saveDateInput.value = getTodayDate(); // Set default date to today
            saveSalesModal.show();
        });

        confirmSaveBtn.addEventListener('click', () => {
            const date = saveDateInput.value;
            const category = saveCategorySelect.value;
            if (date && category) {
                saveSalesData(date, category);
                saveSalesModal.hide();
            } else {
                mostrarNotificacion('Por favor, selecciona una fecha y categoría para guardar.', 'danger');
            }
        });

        loadSalesBtn.addEventListener('click', () => {
            populateLoadSalesDropdown(); // Populate dropdown with saved sales
            loadSalesModal.show();
        });

        confirmLoadBtn.addEventListener('click', () => {
            const selectedKey = loadSalesSelect.value;
            if (selectedKey) {
                loadSalesData(selectedKey);
                loadSalesModal.hide();
            } else {
                mostrarNotificacion('Por favor, selecciona una venta para cargar.', 'danger');
            }
        });

        // Initial load
        document.addEventListener('DOMContentLoaded', function() {
            actualizarTablaCompras();
            
            // Initial check for sidebar state on load for small screens
            if (window.innerWidth < 768) {
                document.body.classList.remove('sidebar-expanded');
                document.body.classList.remove('no-scroll'); // Ensure no-scroll is off initially on small screens
            }
            // Populate and generate report for the Reports tab if it's the active tab on load
            if (document.getElementById('tab-reportes').classList.contains('show')) {
                populateReporteClienteFilter();
                generarReporteTab();
            }
        });
    </script>
</body>
</html>
